import React, { useState, useEffect } from 'react';

const HungryTim = () => {
  const [piesEaten, setPiesEaten] = useState(0);
  const [isExploded, setIsExploded] = useState(false);
  const [scale, setScale] = useState(1);
  const [currentPlayer, setCurrentPlayer] = useState(1);
  const [loser, setLoser] = useState(null);
  const [explosionThreshold] = useState(Math.floor(Math.random() * 16) + 5);
  const [messiness, setMessiness] = useState([]);
  const [splatters, setSplatters] = useState([]);
  
  useEffect(() => {
    if (piesEaten >= explosionThreshold) {
      setIsExploded(true);
      setLoser(currentPlayer);
      // Generate explosion splatters
      setSplatters(Array(20).fill().map(() => ({
        left: `${Math.random() * 200 - 50}%`,
        top: `${Math.random() * 200 - 50}%`,
        size: `${Math.random() * 5 + 1}rem`,
        rotation: `${Math.random() * 360}deg`,
        delay: Math.random() * 0.5,
        type: Math.random() > 0.5 ? 'ðŸ©¸' : 'ðŸ’¥'
      })));
    } else {
      setScale(1 + (piesEaten * 0.1));
      if (piesEaten > 0) {
        const newMess = Array(Math.floor(piesEaten/2) + 1).fill().map(() => ({
          left: `${Math.random() * 80 + 10}%`,
          top: `${Math.random() * 80 + 10}%`,
          size: `${Math.random() * 3 + 1}rem`,
          rotation: `${Math.random() * 360}deg`,
          type: ['ðŸ¥§', 'ðŸ’¦', 'ðŸŽ', 'ðŸ«'][Math.floor(Math.random() * 4)],
          opacity: Math.random() * 0.7 + 0.3
        }));
        setMessiness(newMess);
      }
    }
  }, [piesEaten, explosionThreshold, currentPlayer]);

  const feedTim = () => {
    if (!isExploded) {
      setPiesEaten(prev => prev + 1);
      setCurrentPlayer(prev => prev === 1 ? 2 : 1);
    }
  };

  const resetTim = () => {
    setPiesEaten(0);
    setIsExploded(false);
    setScale(1);
    setCurrentPlayer(1);
    setLoser(null);
    setMessiness([]);
    setSplatters([]);
  };

  return (
    <div className="flex items-center gap-12 p-8">
      <div className="flex flex-col gap-4 min-w-48">
        <div className="text-xl font-bold">Pies eaten: {piesEaten}</div>
        <div className={`text-lg ${!isExploded ? 'animate-pulse' : ''}`}>
          {!isExploded ? `Player ${currentPlayer}'s turn` : `Player ${loser} lost!`}
        </div>
        
        <button
          onClick={feedTim}
          disabled={isExploded}
          className={`px-4 py-2 rounded ${isExploded ? 'bg-gray-400' : 'bg-blue-500 hover:bg-blue-600'} text-white`}
        >
          Feed Tim a Pie ðŸ¥§
        </button>
        
        {isExploded && (
          <button
            onClick={resetTim}
            className="px-4 py-2 rounded bg-green-500 hover:bg-green-600 text-white"
          >
            New Game
          </button>
        )}
      </div>
      
      {!isExploded ? (
        <div 
          className="relative transition-transform duration-300"
          style={{ transform: `scale(${scale})` }}
        >
          {/* Head */}
          <div className="w-32 h-32 bg-orange-200 rounded-full relative">
            {/* Beard */}
            <div className="absolute bottom-0 w-24 h-16 bg-gray-700 rounded-b-full left-4" 
                 style={{
                   filter: `blur(${piesEaten * 0.5}px)`,
                   transform: `scaleX(${1 + piesEaten * 0.02})`
                 }}></div>
            
            {/* Eyes */}
            <div className="absolute top-12 left-8 w-4 h-4 bg-black rounded-full"
                 style={{transform: `translateY(${piesEaten}px)`}}></div>
            <div className="absolute top-12 right-8 w-4 h-4 bg-black rounded-full"
                 style={{transform: `translateY(${piesEaten}px)`}}></div>
            
            {/* Mouth */}
            <div className="absolute bottom-8 left-1/2 -translate-x-1/2 w-12 h-6 bg-red-400 rounded-full"
                 style={{
                   transform: `scaleY(${1 + piesEaten * 0.1})`,
                   filter: `blur(${piesEaten * 0.3}px)`
                 }}></div>

            {/* Drool */}
            {piesEaten > 2 && Array(Math.floor(piesEaten/2)).fill().map((_, idx) => (
              <div
                key={`drool-${idx}`}
                className="absolute bg-blue-200 opacity-60 rounded-b-full animate-pulse"
                style={{
                  left: `${Math.random() * 40 + 30}%`,
                  height: `${Math.random() * 2 + 1}rem`,
                  width: `${Math.random() * 1 + 0.5}rem`,
                  bottom: '-20px',
                  transform: `rotate(${Math.random() * 20 - 10}deg)`,
                  transformOrigin: 'top'
                }}
              />
            ))}
          </div>
          
          {/* Body with stains */}
          <div className="relative w-48 h-48 bg-blue-500 rounded-3xl -mt-8 overflow-hidden">
            {messiness.map((mess, idx) => (
              <div
                key={`mess-${idx}`}
                className="absolute"
                style={{
                  left: mess.left,
                  top: mess.top,
                  fontSize: mess.size,
                  transform: `rotate(${mess.rotation})`,
                  opacity: mess.opacity
                }}
              >
                {mess.type}
              </div>
            ))}
          </div>
        </div>
      ) : (
        <div className="relative">
          <div className="text-6xl">ðŸ’¥</div>
          {splatters.map((splatter, idx) => (
            <div
              key={`splatter-${idx}`}
              className="absolute animate-ping"
              style={{
                left: splatter.left,
                top: splatter.top,
                fontSize: splatter.size,
                transform: `rotate(${splatter.rotation})`,
                animationDelay: `${splatter.delay}s`,
                animationDuration: '1s'
              }}
            >
              {splatter.type}
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default HungryTim;
